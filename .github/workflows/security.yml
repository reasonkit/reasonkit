name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  # Override .cargo/config.toml target-cpu=native to prevent SIGILL on different runners
  CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: ""

jobs:
  cargo-audit:
    name: "Cargo Audit"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable
      - run: cargo install cargo-audit --locked
      # Run audit without --deny warnings; cargo-deny handles advisory policy
      - name: Run cargo audit
        run: |
          cargo audit --json > audit.json 2>&1 || true
          # Check for critical/high vulnerabilities only
          CRITICAL=$(jq '[.vulnerabilities.list[]? | select(.advisory.severity == "critical")] | length' audit.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.vulnerabilities.list[]? | select(.advisory.severity == "high")] | length' audit.json 2>/dev/null || echo "0")
          echo "Critical: $CRITICAL, High: $HIGH"
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Found critical or high severity vulnerabilities"
            cat audit.json | jq '.vulnerabilities.list[]?' 2>/dev/null || cat audit.json
            exit 1
          fi
          echo "No critical or high severity vulnerabilities found"

  cargo-deny:
    name: "Cargo Deny (${{ matrix.checks }})"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        checks: [advisories, licenses, bans, sources]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: EmbarkStudios/cargo-deny-action@41e9609479b924a5ce9e6e1992f3a98360a85025 # v2
        with:
          command: check ${{ matrix.checks }}

  gitleaks:
    name: "Secret Scanning"
    runs-on: ubuntu-latest
    # Continue on error for org repos without GITLEAKS_LICENSE
    continue-on-error: true
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      - name: Gitleaks License Note
        if: failure()
        run: |
          echo "::notice::Gitleaks requires GITLEAKS_LICENSE secret for organization repos."
          echo "::notice::Get a license at https://gitleaks.io and add it as a repository secret."

  security-summary:
    name: "Security Summary"
    runs-on: ubuntu-latest
    needs: [cargo-audit, cargo-deny, gitleaks]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Audit | ${{ needs.cargo-audit.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Deny | ${{ needs.cargo-deny.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.gitleaks.result == 'success' && '✅ Pass' || (needs.gitleaks.result == 'failure' && '⚠️ Skipped (needs license)' || '❌ Fail') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Run triggered: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
