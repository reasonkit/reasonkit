# =============================================================================
# ReasonKit Monorepo CI Pipeline
# =============================================================================
# Unified CI for all ReasonKit OSS crates in the monorepo
# Triggers: push/PR to main, manual dispatch
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - "reasonkit/**"
      - "reasonkit-core/**"
      - "reasonkit-mem/**"
      - "reasonkit-web/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main]
    paths:
      - "reasonkit/**"
      - "reasonkit-core/**"
      - "reasonkit-mem/**"
      - "reasonkit-web/**"
      - "Cargo.toml"
      - "Cargo.lock"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Detect which crates changed
  # ===========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      mem: ${{ steps.filter.outputs.mem }}
      web: ${{ steps.filter.outputs.web }}
      meta: ${{ steps.filter.outputs.meta }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'reasonkit-core/**'
            mem:
              - 'reasonkit-mem/**'
            web:
              - 'reasonkit-web/**'
            meta:
              - 'reasonkit/**'
            any:
              - 'reasonkit/**'
              - 'reasonkit-core/**'
              - 'reasonkit-mem/**'
              - 'reasonkit-web/**'
              - 'Cargo.toml'

  # ===========================================================================
  # Format Check (runs on any change)
  # ===========================================================================
  format:
    name: Format
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.any == 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # ===========================================================================
  # Clippy Lint (runs on any change)
  # ===========================================================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.any == 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "clippy"

      - name: Clippy (all crates)
        run: cargo clippy --workspace -- -D warnings

  # ===========================================================================
  # Build & Test Matrix
  # ===========================================================================
  test:
    name: Test (${{ matrix.os }} / ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    needs: [changes, format]
    if: needs.changes.outputs.any == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, "1.74"] # MSRV
        exclude:
          - os: macos-latest
            rust: "1.74"

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "test-${{ matrix.os }}-${{ matrix.rust }}"

      - name: Build workspace
        run: cargo build --workspace

      - name: Test workspace
        run: cargo test --workspace

  # ===========================================================================
  # Feature Combinations (meta-crate only)
  # ===========================================================================
  feature-matrix:
    name: Feature Matrix
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.meta == 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Check (full - default)
        run: cargo check -p reasonkit --all-features

      - name: Check (core only)
        run: cargo check -p reasonkit --no-default-features --features core

      - name: Check (mem only)
        run: cargo check -p reasonkit --no-default-features --features mem

      - name: Check (web only)
        run: cargo check -p reasonkit --no-default-features --features web

      - name: Check (no features)
        run: cargo check -p reasonkit --no-default-features

  # ===========================================================================
  # Documentation Build
  # ===========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.any == 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2

      - name: Build docs
        env:
          RUSTDOCFLAGS: --cfg docsrs -D warnings
        run: cargo doc --workspace --no-deps

      - name: Upload docs artifact
        uses: actions/upload-artifact@v6
        with:
          name: documentation
          path: target/doc

  # ===========================================================================
  # Security Audit
  # ===========================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.any == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: cargo audit

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [format, clippy, test, docs, security]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          results="${{ needs.format.result }} ${{ needs.clippy.result }} ${{ needs.test.result }} ${{ needs.docs.result }} ${{ needs.security.result }}"
          for result in $results; do
            if [[ "$result" == "failure" ]]; then
              echo "❌ One or more jobs failed"
              exit 1
            fi
          done
          echo "✅ All CI checks passed!"
